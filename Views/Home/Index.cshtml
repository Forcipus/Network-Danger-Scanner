@{
    
}

<style>
    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        background-attachment: fixed;
        color: #f8fafc;
        font-family: 'Inter', -apple-system, sans-serif;
    }

    .main-card {
        background: #ffffff;
        color: #1e293b;
        border: none;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    }

    .section-title {
        font-weight: 700;
        letter-spacing: -0.025em;
        color: #334155;
        text-transform: uppercase;
        font-size: 1.2rem;
    }

    
    .accordion-item {
        border: 1px solid #e2e8f0;
        margin-bottom: 10px;
        border-radius: 8px !important;
        overflow: hidden;
    }

    .accordion-button {
        font-weight: 600;
        font-size: 0.95rem;
        background-color: #f8fafc;
    }

    .accordion-button:not(.collapsed) {
        background-color: #f1f5f9;
        color: #2563eb;
        box-shadow: none;
    }

    .code-block {
        background-color: #020617 !important;
        color: #38bdf8 !important;
        padding: 1.25rem;
        border-radius: 6px;
        font-family: 'Fira Code', 'Cascadia Code', monospace;
        font-size: 0.85rem;
        margin: 0;
    }

    .status-badge {
        padding: 0.5em 1em;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .list-group-item {
        background: transparent;
        border-color: #f1f5f9;
        padding: 1rem 0.5rem;
    }

    input.form-control-lg {
        border: 2px solid #e2e8f0;
        font-size: 1rem;
    }

    input.form-control-lg:focus {
        border-color: #3b82f6;
        box-shadow: none;
    }
</style>



<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
            
            <div class="card main-card p-4">
                <h1 class="section-title text-center mb-4">Query</h1>

                <form id="analyzeForm" class="d-flex gap-2 mb-5">
                    <input id="queryInput" class="form-control form-control-lg" type="text" placeholder="IP, Domain veya URL" required />
                    <button class="btn btn-primary px-4 fw-bold" type="submit">ANALİZ</button>
                </form>

                <div id="resultsCard" class="mb-5" style="display:none;">
                    <div class="pb-3 mb-4 border-bottom d-flex justify-content-between align-items-end">
                        <h2 class="section-title m-0">Analiz Detayları</h2>
                        <div id="riskBadgeContainer"></div>
                    </div>
                    
                    <div id="fixedResults" class="mb-4 p-3 bg-light rounded border small text-secondary">
                        </div>

                    <div class="accordion" id="apiAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#vtCollapse">
                                    VirusTotal Verisi
                                </button>
                            </h2>
                            <div id="vtCollapse" class="accordion-collapse collapse" data-bs-parent="#apiAccordion">
                                <div class="accordion-body p-0">
                                    <pre id="vtRaw" class="code-block"></pre>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#abuseCollapse">
                                    AbuseIPDB Verisi
                                </button>
                            </h2>
                            <div id="abuseCollapse" class="accordion-collapse collapse" data-bs-parent="#apiAccordion">
                                <div class="accordion-body p-0">
                                    <pre id="abuseRaw" class="code-block"></pre>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#shodanCollapse">
                                    Shodan Verisi
                                </button>
                            </h2>
                            <div id="shodanCollapse" class="accordion-collapse collapse" data-bs-parent="#apiAccordion">
                                <div class="accordion-body p-0">
                                    <pre id="shodanRaw" class="code-block"></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mt-4 gap-3 align-items-center">
                        <div id="loadingSpinner" class="spinner-border text-primary spinner-border-sm" style="display:none;"></div>
                        <button id="saveBtn" class="btn btn-outline-success fw-bold px-4">VERİTABANINA KAYDET</button>
                    </div>
                </div>

                <div id="savedSection">
                    <h2 class="section-title border-bottom pb-2 mb-3">Geçmiş Raporlar</h2>
                    <ul id="reportList" class="list-group list-group-flush">
                        </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    const analyzeForm = document.getElementById('analyzeForm');
    const queryInput = document.getElementById('queryInput');
    const resultsCard = document.getElementById('resultsCard');
    const fixedResults = document.getElementById('fixedResults');
    const saveBtn = document.getElementById('saveBtn');
    const reportList = document.getElementById('reportList');
    const loadingSpinner = document.getElementById('loadingSpinner');

    let currentReport = null;


    /* BOOTSTRAP FALLBACK*/

    document.querySelectorAll('.accordion-button').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-bs-target');
            const targetEl = document.querySelector(targetId);
            
            if (window.bootstrap && window.bootstrap.Collapse) {
                const bsCollapse = bootstrap.Collapse.getOrCreateInstance(targetEl);
            } else {
                targetEl.classList.toggle('show');
                this.classList.toggle('collapsed');
            }
        });
    });


    /* ANALİZ TETİKLEYİCİ*/
    analyzeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const q = queryInput.value.trim();
        if (!q) return;

        resultsCard.style.display = 'block';
        fixedResults.innerHTML = '<div class="py-3 text-muted">İstihbarat verileri toplanıyor...</div>';
        
        try {
            const res = await fetch(`/api/ThreatIntel/lookup?query=${encodeURIComponent(q)}`);
            const data = await res.json();
            currentReport = data;
            displayResults(data);
        } catch (err) {
            fixedResults.innerHTML = `<div class="text-danger">Veri çekme hatası: ${err.message}</div>`;
        }
    });

    /*SONUÇ GÖRÜNTÜLEME*/
    function displayResults(data) {
        const risk = data.overallRisk || "Unknown";
        const color = getRiskColor(risk);
        
        document.getElementById('riskBadgeContainer').innerHTML = `<span class="status-badge bg-${color} text-white">${risk.toUpperCase()} RİSK</span>`;
        
        fixedResults.innerHTML = `
            <div><strong>Sorgu Hedefi:</strong> ${data.query}</div>
            <div><strong>IP Adresi:</strong> ${data.resolvedIP || '-'}</div>
        `;

        document.getElementById('vtRaw').innerText = data.virusTotal ? JSON.stringify(data.virusTotal, null, 2) : "Veri yok";
        document.getElementById('abuseRaw').innerText = data.abuseIPDB ? JSON.stringify(data.abuseIPDB, null, 2) : "Veri yok";
        document.getElementById('shodanRaw').innerText = data.shodan ? JSON.stringify(data.shodan, null, 2) : "Veri yok";
    }

    /*KAYDETME*/
    saveBtn.addEventListener('click', async () => {
        if (!currentReport) return;
        saveBtn.disabled = true;
        loadingSpinner.style.display = 'inline-block';

        const cleanReport = {
            query: currentReport.query,
            resolvedIP: currentReport.resolvedIP,
            overallRisk: currentReport.overallRisk
        };

        try {
            const res = await fetch('/api/ThreatIntel/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cleanReport)
            });
            if (res.ok) {
                const j = await res.json();
                cleanReport.id = j.id;
                saveLocal(cleanReport);
                loadReports();
            }
        } finally {
            saveBtn.disabled = false;
            loadingSpinner.style.display = 'none';
        }
    });

    /*RAPOR YÜKLEME*/
    async function loadReports() {
        reportList.innerHTML = '';
        let dbReports = [];
        try {
            const res = await fetch('/api/ThreatIntel/saved');
            if (res.ok) dbReports = await res.json();
        } catch (e) {}

        dbReports.forEach(r => {
            const rid = r.id || r._id;
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <div>
                    <span class="fw-bold text-dark">${r.query}</span>
                    <span class="ms-2 small text-${getRiskColor(r.overallRisk)} fw-bold">${r.overallRisk}</span>
                </div>
                <button class="btn btn-sm text-danger fw-bold" onclick="deleteReport('${rid}', '${r.query}')">SİL</button>
            `;
            reportList.appendChild(li);
        });
    }

    window.deleteReport = async (id, query) => {
        if (!confirm('Rapor silinsin mi?')) return;
        if (id && id !== "undefined") {
            try { await fetch(`/api/ThreatIntel/delete/${id}`, { method: 'DELETE' }); } catch (e) {}
        }
        loadReports();
    };

    function getRiskColor(risk) {
        const r = (risk || '').toLowerCase();
        if (r.includes('low')) return 'success'; //Green
        if (r.includes('medium')) return 'warning'; //Yellow
        if (r.includes('high')) return 'danger';  //Kırmızı
        return 'secondary';
    }

    loadReports();
</script>